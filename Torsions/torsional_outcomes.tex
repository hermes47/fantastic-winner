\documentclass[11pt, oneside, draft]{article}   	% use "amsart" instead of "article" for AMSLaTeX format
\usepackage{geometry}                		% See geometry.pdf to learn the layout options. There are lots.
\geometry{a4paper}
%\addtolength{\hoffset}{2cm}
%\addtolength{\marginparwidth}{2cm}
                   		% ... or a4paper or a5paper or ... 
%\geometry{landscape}                		% Activate for for rotated page geometry
%\usepackage[parfill]{parskip}    		% Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}				% Use pdf, png, jpg, or epsÂ§ with pdflatex; use eps in DVI mode
								% TeX will automatically convert eps --> pdf in pdflatex		
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage[version=3]{mhchem}
\usepackage{rotating}
\usepackage{hyperref}
\usepackage{float}
\usepackage{verbatimbox}
%\usepackage[obeyspaces,spaces]{url}
\usepackage{textcomp}
\usepackage{color}
\usepackage[normalem]{ulem}
\usepackage[obeyDraft, obeyFinal, textsize=scriptsize]{todonotes}
\usepackage{multirow}
\usepackage{enumitem}
\reversemarginpar

\title{Fitting to torsional profiles}
\author{Ivan Welsh}
%\date{}							% Activate to display a given date or no date

\floatstyle{plain}
\newfloat{example}{thp}{exp}
\floatname{example}{Example}

\setcounter{secnumdepth}{2}

\newcommand{\done}[1]{\todo[backgroundcolor=blue!30, linecolor=blue]{#1}}
\newcommand{\todiscuss}[1]{\todo[backgroundcolor=red!50, linecolor=red]{#1}}
\newcommand{\finished}[1]{\todo[backgroundcolor=green!60, linecolor=green]{#1}}

\begin{document}
\maketitle

\section{Molecules}
A set of twenty, simple organic molecules were chosen for this investigation. The aim of the investigation was to determine the bonded distance required between a dihedral of interest and a functional group, for the functional group to have minimalism effect on the dihedral rotation profile. The molecules used are shown in figure~\ref{fig:structures}.\\
In order to investigate the dihedral rotation profiles, QM calculations where the dihedral of interest ($\psi$ in figure~\ref{fig:structures}) has been fixed at a given value, for a range of values. At each fixed value, the structure was optimised. Energy differences between the fixed values give the dihedral rotational profile. All calculations were performed with the B3LYP density functional.
\begin{sidewaysfigure}[p]
\centering
\includegraphics[width=0.9\textheight]{Images/molecules}
\caption{Structures of molecules torsional profiles attained for}
\todo[inline]{Need to add the -1 row}
\label{fig:structures}
\end{sidewaysfigure}

\section{Basis Sets}
A quick look at the effect of basis set on the dihedral rotation profile was under taken. The molecules shown in row 0 of figure~\ref{fig:structures} were exclusively used for this investigation. $\psi$ was fixed at 15 degree increments in the range of 0 to 360 degrees, to give 24 regularly spaced conformations for each molecule. All calculations were performed at five different basis set levels (6-31G(d), 6-31+G(d), 6-311+G(2d,p), 6-311++G(2d,2p) and 6-311++G(3df,3p)) to determine the basis set error. RMSD results are given in table~\ref{tb:basis_set_rmsd}.

\begin{table}[p]
\centering
\caption{RMSD values obtained from QM calculations of the dihedral rotational profile a the 0 row of molecules. Two RMSD values are given. The first is the RMSD between the QM calculated energy values and the energy values determined from a two pass fitting of three dihedral terms to the energy profile. The second is the RMSD between the energies determined from fits at the given basis set against the smallest basis set. All energies are in kJ~mol$^{-1}$.}
\label{tb:basis_set_rmsd}
\begin{tabular}{|c|l|c|c|}
\hline
Molecule                 & Basis Set        & RMSD w.r.t QM & RMSD w.r.t 6-31G(d) \\ \hline
\multirow{5}{*}{AMINO0}  & 6-31G(d)         & 2.07          & 0.00                \\ \cline{2-4} 
                         & 6-31+G(d)        & 2.59          & 0.43                \\ \cline{2-4} 
                         & 6-311+G(2d,p)    & 2.55          & 0.48                \\ \cline{2-4} 
                         & 6-311++G(2d,2p)  & 2.52          & 0.48                \\ \cline{2-4} 
                         & 6-311++G(3df,3p) & 2.51          & 0.37                \\ \hline
\multirow{5}{*}{CHLORO0} & 6-31G(d)         & 2.91          & 0.00                \\ \cline{2-4} 
                         & 6-31+G(d)        & 3.09          & 0.14                \\ \cline{2-4} 
                         & 6-311+G(2d,p)    & 3.13          & 0.63                \\ \cline{2-4} 
                         & 6-311++G(2d,2p)  & 3.13          & 0.70                \\ \cline{2-4} 
                         & 6-311++G(3df,3p) & 3.14          & 0.51                \\ \hline
\multirow{5}{*}{HYDRO0}  & 6-31G(d)         & 1.69          & 0.00                \\ \cline{2-4} 
                         & 6-31+G(d)        & 2.59          & 1.04                \\ \cline{2-4} 
                         & 6-311+G(2d,p)    & 2.48          & 1.10                \\ \cline{2-4} 
                         & 6-311++G(2d,2p)  & 2.45          & 1.13                \\ \cline{2-4} 
                         & 6-311++G(3df,3p) & 2.45          & 1.02                \\ \hline
\multirow{5}{*}{METH0}   & 6-31G(d)         & 3.26          & 0.00                \\ \cline{2-4} 
                         & 6-31+G(d)        & 3.44          & 0.21                \\ \cline{2-4} 
                         & 6-311+G(2d,p)    & 3.37          & 0.15                \\ \cline{2-4} 
                         & 6-311++G(2d,2p)  & 3.36          & 0.15                \\ \cline{2-4} 
                         & 6-311++G(3df,3p) & 3.39          & 0.15                \\ \hline
\multirow{5}{*}{THIO0}   & 6-31G(d)         & 3.36          & 0.00                \\ \cline{2-4} 
                         & 6-31+G(d)        & 3.56          & 0.18                \\ \cline{2-4} 
                         & 6-311+G(2d,p)    & 3.53          & 0.38                \\ \cline{2-4} 
                         & 6-311++G(2d,2p)  & 3.52          & 0.42                \\ \cline{2-4} 
                         & 6-311++G(3df,3p) & 3.56          & 0.37                \\ \hline
\end{tabular}
\end{table}  

\begin{figure}[htb]
\centering
\includegraphics[scale=0.7]{BasisSets/Figures/METH0/Combined}
\caption{Dihedral rotational energy profile of METH0 $\psi$ as calculated with 5 different basis sets}
\label{fig:meth0_basis}
\end{figure}
    
\begin{figure}[htb]
\centering
\includegraphics[scale=0.7]{BasisSets/Figures/HYDRO0/Combined}
\caption{Dihedral rotational energy profile of HYDRO0 $\psi$ as calculated with 5 different basis sets}
\label{fig:hydro0_basis}
\end{figure}

Results indicate that it should acceptable for further calculations to be performed at the B3LYP/6-31G(d) level of theory. The two RMSD values reported, indicate different things. The first (RMSD w.r.t QM) is the RMSD between the QM calculated energies and energies calculated by performing a two-pass, linear least squares fitting to the QM energies, using the equation $U = \sum k_i \cdot \cos(m_i\theta + \delta)$. The least squares solves for $k_i$ and (indirectly) $\delta$. A negative $k_i$ gives a $\delta$ of 180, positive a $\delta$ of 0. The two-pass nature performs a first pass, where values of $m_i = 0 \to 6$ are used to generate linear equations, which are solved for $k_i$ and sorted based on the magnitude of $k_i$. The most important $N$ values of $m_i$ are then set as the only possible values, and passed through the same fitting process again. $m_i = 0$ is always in this fitting to account for any DC shift within the data. The RMSD obtained between the QM energies and the fitted energies gives an indication of how good the fit is. As shown in table~\ref{tb:basis_set_rmsd}, the RMSD between the QM calculated energies and the energies calculated from fits sits slightly higher than $k_bT$ (this RMSD drops to less than 0.5 kJ mol$^{-1}$ when phase is also fitted), which shows a reasonable fit is obtained.\\
The second RMSD value reported in ~\ref{tb:basis_set_rmsd} are the RMSD values between the energies as calculated from the fits of the basis set of interest, and the smallest basis set used here in (6-31G(d)). In all cases, these values remain below $\frac{1}{2}k_bT$, indicating that, in these molecules, there is not much gained from using a much larger basis set. This is further reinforced through inspection of the overlaid energy profiles for the least (figure~\ref{fig:meth0_basis}) and most (figure~\ref{fig:hydro0_basis}) deviated examples. Even in the largest deviation present in the HYDRO0 molecule energy profiles, the 6-31G(d) basis set still performs remarkably well when compared with the larger basis sets.\\
As such, all further QM calculations will be performed at the B3LYP/6-31G(d) level of theory.

\section{Fitting}
Torsional energy profiles can be described with a Fourier series, a potentially infinite set of cosines. For molecular dynamics simulations, it is desirable to have a finite series of cosine terms describing the torsional energy profile. Going from the raw data of the energy profile, to the explicit series of cosines requires a fitting process to be under taken. Given a data set spanning a full revolution of a torsional angle, there are a number of possible methods to fit a finite series of cosines to this data set. In each case, there is a need to perform a linear least squares fitting procedure.

\subsection{Using simultaneous linear equations to fit to a Fourier series}
A Fourier series describing the torsional potential of conformation $j$ is given by
\begin{equation}
V_{j} = \sum_{i=1}^{N}k_{i}({1 + \cos(m_{i}\theta_{j} - \delta_{i})})
\end{equation}
where $V_{j}$ is the potential of the system at conformation $j$, $k_{i}$ is the amplitude of the $i$-th term, $m_{i}$ is the multiplicity associated with the term, $\theta_{j}$ is the dihedral angle of conformation $j$, and $\delta_{i}$ is the phase shift associated with the $i$-th term. In general usage, $\delta_{i}$ is limited to be either 0 or $\pi$. With this limit imposed, the Fourier series becomes:
\begin{equation}
V_{j} = C + \sum_{i=1}^{N}k_{i}\cos(m_{i}\theta_{j})\cos\delta_{i}
\end{equation}
where $C = \sum_{i=1}^{N}{k_{i}}$. As $\delta_{i}$ is limited to being either 0 or $\pi$, $\cos\delta_{i} = \pm 1$, meaning it can ignored (a negative $k_{i}$ value can be converted to a positive value with a $\delta_{i}$ of $\pi$). By providing a list of $n$, $m_{i}$ values (multiplicities are integer values, and so do not need to be fit to), this becomes a series of $N$ simultaneous equations in $n$ variables, the $k_{i}$ values. This can then be written in the matrix form of $b = Ax$:

\begin{equation}
\\
\begin{bmatrix}
V_{1} - c^{V}\\
V_{2} - c^{V}\\
\vdots\\
V_{N} - c^{V} 
\end{bmatrix}
 = 
\begin{bmatrix}
\cos(m_{1}\theta_{1})-c_{1}^A & \cos(m_{2}\theta_{1})-c_{2}^A & \ldots & \cos(m_{n}\theta_{1})-c_{n}^A \\
\cos(m_{1}\theta_{2})-c_{1}^A & \cos(m_{2}\theta_{2})-c_{2}^A & \ldots & \cos(m_{n}\theta_{2})-c_{n}^A \\
\vdots & \vdots & \ddots & \vdots \\
\cos(m_{1}\theta_{N})-c_{1}^A & \cos(m_{2}\theta_{N})-c_{2}^A & \ldots & \cos(m_{n}\theta_{N})-c_{n}^A \\
\end{bmatrix}
\begin{bmatrix}
k_{1} \\
k_{2} \\
\vdots \\
k_{n}
\end{bmatrix}
\end{equation}
where $c^V = \frac{1}{N}\sum_{j=1}^{N} V_{j}$ and $c_{i}^{A} = \frac{1}{N}\sum_{j=1}^{N} \cos(m_{i}\theta_{j})$. A least squares solving of this matrix equation can then be undertaken, and the values of $k_{i}$ obtained. It is trivial to extended this method to fit to multiple torsional angles simultaneously.

\subsubsection{Expanding to variable $\delta$}
As defined thus far, the matrix means of solving the simultaneous equations is unable to solve the equations if $\delta_{i}$ is allowed to vary from 0/$\pi$. This is because the equations will become nonlinear, and linear least squares is unable to solve this. However, there is a way to convert the nonlinear, variable phase (ie having to fit $k_{i}$ and $\delta_{i}$) equations into linear equations than can be fit.\\
If the individual torsional energy terms are treated as phasors, we can use the phasor addition rule to show that:
\begin{equation}
k_{i}(1 + \cos(m_{i}\theta - \delta_{i})) = k_{i,a}(1 + \cos(m_{i}\theta - \delta_{a})) + k_{i,b}(1 + \cos(m_{i}\theta - \delta_{b}))
\end{equation}
Then, if $\delta_{a}$ and $\delta_{b}$ are set to predetermined, non equal values, we are left with linear simultaneous equations which can be solved as per above. The solutions will give the values $k_{i,a}$ and $k_{i,b}$, but the desired results are $k_{i}$ and $\delta_{i}$. It is trivial to obtain these values from the fit determined values:
\begin{eqnarray}
k_{i}^2  = & (k_{i,a}\cos\delta_{a} + k_{i,b}\cos\delta_{b})^2 + (k_{i,a}\sin\delta_{a} + k_{i,b}\sin\delta_{b})^2\\
\delta_{i} = & \arctan\Big(\frac{k_{i,a}\sin\delta_{a} + k_{i,b}\sin\delta_{b}}{k_{i,a}\cos\delta_{a} + k_{i,b}\cos\delta_{b}}\Big)
\end{eqnarray}

\subsection{Fitting methods}
\begin{enumerate}[label=\alph*)]
\item \textbf{Single pass:} a single pass fit involves a single generation and solve of the linear equations. The data, a list of the multiplicity values to be included in the fit, and an optional limit, $N$ to the number of output multiplicities are provided. The matrices are generated and solved using all the provided multiplicity values, giving the $k_{i}$ and $\delta_{i}$ obtained for each multiplicity $m_{i}$. The multiplicities are sorted in descending order based on the $k_{i}$ value determined. If a limit has been provided, the first $N$ multiplicity, amplitude and phase tuples are returned as the fitted results.
\item \textbf{Twin pass:} a twin pass fit performs two single pass fits. The first single pass is as described above, with a limit of $N$ values to be returned. The second pass takes the returned $N$ multiplicities and performs a fit with only those values. In this way, the refitted parameters will hopefully be a better fit to the data than the `truncated' parameters, as they compensate slightly for the fitting provided by the discarded parameters.
\item \textbf{Multi pass:} instead of relying on a sorted list of fit parameters to determine the $N$ parameters to use, a multi pass method performs fits with all possible combinations of multiplicity values of length $N$. Thus, if the possible multiplicities are (1, 2, 3, 6), and $N = 3$, the fits performed will have multiplicities (1, 2, 3), (1, 2, 6), (1, 3, 6), and (2, 3, 6). Each fit performed has an error, $\epsilon$, associated with it, between the fit and the raw data. The fit with the lowest such error would thus be determined to be the best fit, and the one to use. A simple error estimation function to use would be the RMSD:
\begin{equation}
\epsilon = \sqrt{\frac{1}{J}\sum_{j=1}^{J}\big(V_{\text{raw}}(\theta_{j}) - V_{\text{fit}}(\theta_{j})\big)^{2}}
\end{equation}
Of course, any other error estimation function is also usable.

\end{enumerate}
\subsection{Pruning outliers(???)}
\subsection{Difference data}
Determining MD torsional parameters is the aim of this fitting procedure. Data obtained from QM calculations and MD minimisations (where the torsional terms fitting for have been removed/zeroed out of the topology) provide the reference data. The difference between the relative energies of QM and MD data is the data to be fit by the fitting process. In order to obtain this difference data, there are a number of possible methods to use.
\begin{enumerate}
\item Difference of raw data. In this approach, each raw QM datum has the MD datum at the same, fixed torsional value subtracted from it, in order to give the reference value for that point. Though this approach is the most obvious means of determining the difference data, it has a downside. Both the QM data (which is expensive to calculate) and the MD data (which has negligible computational cost), must be determined at the same points, which may not always be desirable or possible.
\item Subtract one set of raw data from calculated data determined from a fit to the other set of raw data. In this approach, two fitting processes are performed. The first is to set to one set of the raw data, for example a high density sampling MD data set, and the second to the difference between the raw data of the other, and the calculated of the first. This method does allow for differing sampling densities, which may be useful.
\item Fit both sets of raw data, and then calculate and fit the difference between them. This is probably the most versatile fitting method. For example, one perform a one pass fit, with no limit, to the raw QM and MD data, utilising the ability to fit phase, and then perform a multi pass fit to the calculated difference, without fitting phase. In this way, very good fits to the QM and MD data could be obtained, while allowing the difference data to be fit in a manner consistent with the force field parameterisation philosophy.
\end{enumerate}

\section{Results}
\subsection{Fitting methods}
Each of the three fitting methods described were tested on 50,000 sets of randomly generated periodic data, and 113 sets of real data, from QM, all-atom MD and united atom MD. Random data was generated by from a Fourier series of all multiplicities up to 12. Each term has a randomly generated amplitude, and phase as well as a small amount of noise applied. Real data came from a set of QM, AA-MD and UA-MD calculations performed for later testing purposes. Fitting was performed to generate a 3 term fit.\\
Fitting to the random data gave identical results within all the phased and non-phased fits. Non-phased fits naturally had a larger RMSD when compared with the phased fit, but all three non-phased fits results were the same, as were all three phased fit results. Real data fitting gave similar results. Two pass and multi pass fitting methods gave identical results, as would be expected. One pass fitting had RMSD values slightly larger than the two/multi pass methods; on average a 0.001\% variation (from the RMSD of the two/multi pass methods) for the non-phased fit, and a 0.05\% variation for the phased fits. The difference between the random and real data fitting (ie that real had slight differences between the one pass and other fitting methods when random did not) probably arises from the way noise was provided to the random generation method. In the real data, there is small amounts of noise (defining noise as differing from the data falling on a perfect periodic function) in each of the data points. However, a few data points have much larger deviation from the curve. This larger deviation was not modelled by the random generation, as noise was applied to the generating cosine functions, not the generated data points. Regardless, these results indicate that it should be perfectly reasonable to perform fitting with the cheapest one-pass method, without having any noticeable difference in the quality of the fits.

\subsection{Difference data}
The three methods to determine the difference data are tested. The aim of these tests is to determine which methods provide the best means of calculating the required torsional terms. Tests are run on the -1 series of molecules. The tests are:
\begin{itemize}
\item $\text{QM}_{\text{raw}} - \text{MD}_{\text{raw}} = \text{DIFF}$. Fit phased and non-phased to DIFF. MD using both AA and UA. (4 total tests)
\item Fit to $\text{MD}_{\text{raw}}$ using phased and non-phased. $\text{QM}_{\text{raw}} - \text{MD}_{\text{fit}} = \text{DIFF}$. Fit phased and non-phased to DIFF. MD using both AA and UA. (8 total tests)
\item Fit to $\text{QM}_{\text{raw}}$ using phased and non-phased. $\text{QM}_{\text{fit}} - \text{MD}_{\text{raw}} = \text{DIFF}$. Fit phased and non-phased to DIFF. MD using both AA and UA. (8 total tests)
\item Fit to both $\text{MD}_{\text{raw}}$ and $\text{QM}_{\text{raw}}$, using phased and non-phased (but \emph{not} mixing the fits). $\text{QM}_{\text{fit}} - \text{MD}_{\text{fit}} = \text{DIFF}$. Fit phased and non-phased to DIFF (non-phased can be fit to phased raw data, but phased cannot be fit to non-phased raw data). MD using both AA and UA. (6 total tests)
\end{itemize}
These give a total of 26 different tests to be performed, on the 5 molecules in the -1 series

\end{document}  
